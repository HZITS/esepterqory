<link rel="import" href="dashboard-add-topic-module.html">
<link rel="import" href="dashboard-add-problem-module.html">
<link rel="import" href="dashboard-problem-module.html">
<link rel="import" href="dashboard-problems-cell-module.html">
<link rel="import" href="dashboard-pages-module.html">

<dom-module id="dashboard-module">
    <template>
        <style include="shared-styles">
            
            :host{
                display: block;
                background-color: white;
                display: flex;
                flex-flow: column;
            }

            list-module{
                flex: 0 1 auto;
                height: calc(100vh - 122px);
                border-right: 1px solid var(--paper-grey-300);                           
            }

            dashboard-problem-module {
                flex: 1 1 auto
            }
        
            .body{
                background-color: white;
                display: flex;
                flex-flow: column;
            }

            .topic:hover, .listItem:hover {
                color: black;
                cursor: pointer;
            }

            .listItem:hover {
                background-color: var(--paper-grey-300)
            }

            .listItem{
                height: 32px;
                line-height: 32px;
                color: var(--paper-grey-700);
                padding-left: 16px; 
            }
            .list{
                overflow: auto;
                height: calc(100vh - 123px)
            }
            iron-icon{
                color: var(--paper-grey-600)
            }
            .edit{
                height: 40px;
                cursor: pointer
            }
        </style>

        <app-location route="{{route}}"></app-location>
        <app-route
            route="{{route}}"
            pattern="/dashboard/:page"
            data="{{routeData}}"
            tail="{{subroute}}">
        </app-route>
        <div class="body layout horizontal">
            <list-module
                show-title
                title="[[topic.title]]"
                button-title="Добавить подтему"    
                event="add-topic"
                style="width:300px"
            >   
                <div slot="actions" class="layout horizontal">
                    <iron-icon class="edit" on-click="edit" icon="icons:create"></iron-icon>
                    <iron-icon class="edit" on-click="delete" icon="icons:delete"></iron-icon>
                </div>
                <iron-list slot="list" items="[[topic.subtopics]]">
                    <template>
                        <a class="listItem" href$="dashboard/[[item._id]]">
                            [[item.title]]([[item.problemsCount]])
                        </a>
                    </template>
                </iron-list>
            </list-module>
            <list-module
                show-title
                style="width:500px"
                title="[[problem.title]]"
                button-title="[[problem.buttonTitle]]"  
                event="add-problem"
            >
                <a target="_blank" href="/api/download/topic/[[topic._id]]" slot="actions" class="layout horizontal">
                    <iron-icon class="edit" on-click="delete" icon="icons:file-download"></iron-icon>
                </a>
                <iron-list slot="list" id="problems" items="[[problems]]" selection-enabled selected-item="{{selectedProblem}}">
                    <template>
                        <dashboard-problems-cell-module selected="[[selected]]" problem="[[item]]"></dashboard-problems-cell-module>
                    </template>
                </iron-list> 
                <dashboard-pages-module id="pages" slot="footer" topic="[[topic]]" problems="{{problems}}"></dashboard-pages-module>
            </list-module>
            <dashboard-problem-module 
            title="[[selectedProblem.number]]"
            data="[[selectedProblem]]">
            </dashboard-problem-module>
        </div>            
    
        <isw-dialog id="problemDialog" with-backdrop>
            <dashboard-add-problem-module problem="[[editProblem]]" topic="[[topic]]"></dashboard-add-problem-module>
        </isw-dialog>
        <isw-dialog id="topicDialog" with-backdrop>
            <dashboard-add-topic-module topic="[[topic]]"></dashboard-add-topic-module>
        </isw-dialog>
         
    </template>
    <script>
        class DashboardModule extends Polymer.Element {

            static get is() { return 'dashboard-module' }

            static get properties() {
                return {
                    section: Object,
                    topic: {
                        type: Object,
                        observer: "topicChanged"
                    },
                    currentListener: Object,
                    page: {
                        type: String,
                        observer: 'pageChanged',
                    },
                    currentPage: String,
                    routeData: Object,
                    subroute: String,
                    problem: {
                        type: Object,
                        value: {}
                    },
                    path: {
                        type: Array,
                        reflectToAttribute: true,
                        notify: true
                    }
                }
            }

            static get observers() {
                return [    
                    "routePageChanged(routeData.page)"
                ]
            }

            connectedCallback(){
                super.connectedCallback()

                 dispatcher.subscribe('math-rendered',_ => {
                    this.$.problems.notifyResize()
                 })

                this.addEventListener('add-topic',e => {
                    this.$.topicDialog.open()
                })
                this.addEventListener('edit-problem',e => {
                    this.$.problemDialog.open()
                    this.editProblem = e.detail.problem
                })
                this.addEventListener('add-problem',e => {
                    this.$.problemDialog.open()
                })

                this.addEventListener('reload-problems', e => {
                    this.$.pages.pageChanged(this.$.pages, this.topic)
                })
            }

            routePageChanged(page){ 
                this.page = page
            }

            pageChanged(page){
                ajax().get("/api/topics/" + page, { populate: true})
                .then( res => {
                    var topic = res
                    if (!(topic.subtopics instanceof Array)){
                        topic.subtopics = [topic.subtopics]
                    }
                    this.topic = topic
                    console.log(this.topic.title)
                })
            }

            topicChanged(topic){
                
                if(topic){
                    
                    this.path = topic.topicsPath

                    if(topic.path.split('/').length > 1){
                        this.problem = {
                            title: "Задачи в: " + topic.title,
                            buttonTitle: 'Добавить задачу'
                        } 
                    } else {
                        this.problem = null
                    }

                }
            }

        }
        customElements.define(DashboardModule.is, DashboardModule);
    </script>
</dom-module