<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../redux-store.html">

<link rel="import" href="dashboard-add-topic-module.html">
<link rel="import" href="dashboard-add-problem-module.html">
<link rel="import" href="dashboard-problem-module.html">
<link rel="import" href="dashboard-problems-cell-module.html">
<link rel="import" href="dashboard-pages-module.html">

<dom-module id="dashboard-module">
    <template>
        <style include="shared-styles">
            
            :host{
                display: block;
                background-color: white;
                display: flex;
                flex-flow: column;
            }

            list-module{
                flex: 0 1 auto;
                height: calc(100vh - 82px);
                border-right: 1px solid var(--paper-grey-300);                           
            }

            dashboard-problem-module {
                flex: 1 1 auto
            }
        
            .body{
                background-color: white;
                display: flex;
                flex-flow: column;
            }

            .topic:hover, .listItem:hover {
                color: black;
                cursor: pointer;
            }

            .listItem:hover {
                background-color: var(--paper-grey-300)
            }

            .listItem{
                height: 32px;
                line-height: 32px;
                color: var(--paper-grey-700);
                padding-left: 16px; 
            }
            .list{
                overflow: auto;
                height: calc(100vh - 123px)
            }
            iron-icon{
                color: var(--paper-grey-600)
            }
            .edit{
                height: 40px;
                margin-left: 8px;
                cursor: pointer
            }
    
        </style>

        <app-location route="{{route}}"></app-location>
        <app-route
            route="{{route}}"
            pattern="/admin/[[page]]/:topicId"
            data="{{routeData}}"
            tail="{{subroute}}">
        </app-route>
        <app-route
            route="{{subroute}}"
            pattern="/:p"
            data="{{subrouteData}}">
        </app-route>
      
        <div class="body layout horizontal">
            <list-module
                show-title
                title="[[topic.title]]"
                button-title="Добавить подтему"    
                event="add-topic"
                style="width:300px"
            >   
                <div slot="actions" class="layout horizontal">
                    <iron-icon class="edit" on-click="editTopic" icon="icons:create"></iron-icon>
                    <iron-icon class="edit" on-click="delete" icon="icons:delete"></iron-icon>
                </div>
                <iron-list slot="list" items="[[topic.subtopics]]">
                    <template>
                        <a class="listItem" href$="admin/[[page]]/[[item._id]]">
                            [[item.title]]([[item.problemsCount]])
                        </a>
                    </template>
                </iron-list>
            </list-module>
            <list-module
                show-title
                style="width:500px"
                title="[[problem.title]]"
                button-title="[[problem.buttonTitle]]"  
                event="add-problem"
            >   
                <template is="dom-if" if="[[problem.title]]">
                    <a slot="actions" target="_blank" href$="/api/download/topic/[[topic._id]]/[[problemsPage]]" class="layout horizontal">
                         <iron-icon class="edit" icon="icons:file-download"></iron-icon>
                    </a>
                </template>
                <iron-list slot="list" id="problems" items="[[problems]]" selection-enabled selected-item="{{selectedProblem}}">
                    <template>
                        <dashboard-problems-cell-module selected="[[selected]]" problem="[[item]]"></dashboard-problems-cell-module>
                    </template>
                </iron-list> 
                <dashboard-pages-module id="topicIds" slot="footer" topic="[[topic]]"></dashboard-pages-module>
            </list-module>
            <dashboard-problem-module 
            title="[[selectedProblem.number]]"
            data="[[selectedProblem]]">
            </dashboard-problem-module>
        </div>            
        <dashboard-add-problem-module
            id="problemDialog"
            problem="[[editProblem]]" 
            topic="[[topic]]"
        ></dashboard-add-problem-module>
        <dashboard-add-topic-module
            id="topicDialog"
            path="[[topic.path]]" 
            topic="[[topicToEdit]]"
        ></dashboard-add-topic-module>
         
    </template>
    <script>
        class DashboardModule extends ReduxMixin(Polymer.Element) {

            static get is() { return 'dashboard-module' }

            static get properties() {
                return {
                    topic: {
                        type: Object,
                        observer: "topicChanged"
                    },
                    currentListener: Object,
                    topicId: {
                        type: String,
                        observer: 'topicIdChanged',
                    },
                    section: {
                        type: String,
                        statePath: 'section'
                    },
                    page: String,
                    routeData: Object,
                    subrouteData: Object,
                    subroute: String,
                    problem: {
                        type: Object,
                        value: {}
                    },
                    problemsPage: {
                        type: Number,
                        value: 1
                    }
                }
            }

            static get observers() {
                return [    
                    "routetopicIdChanged(routeData.topicId)",
                    "sectionChanged(section, topicId)",
                    "problemsPageChanged(subrouteData.p, topic)"
                ]
            }

            connectedCallback(){
                super.connectedCallback()

                 dispatcher.subscribe('math-rendered',_ => {
                    this.$.problems.notifyResize()
                 })

                this.addEventListener('add-topic',e => {
                    this.topicToEdit = null
                    this.$.topicDialog.open()
                })
                this.addEventListener('reload-topic',e => {
                    this.getTopic(this.routeData.topicId)
                })

                this.addEventListener('edit-problem',e => {
                    this.$.problemDialog.open()
                    this.editProblem = e.detail.problem
                })
                this.addEventListener('add-problem',e => {
                    this.$.problemDialog.open()
                })

                this.addEventListener('reload-problems', e => {
                    this.getProblems(1, this.topic)
                })
            }

            editTopic(){
                this.topicToEdit = this.topic
                this.$.topicDialog.open()
            }

            routetopicIdChanged(topicId){ 
                this.topicId = topicId
            }

            problemsPageChanged(p, topic){
                this.getProblems(p, topic)
            }

            sectionChanged(s, topicId){
                if(s == this.page && !topicId ){
                    this.getTopic(this.page)
                }
            }

            topicIdChanged(topicId){
                this.getTopic(topicId)
            }

            getTopic(id){
                ajax().get("/api/topics/" + id, { populate: true})
                .then( res => {
                    if(res == "doesn't exist") return

                    var topic = res
                    if (!(topic.subtopics instanceof Array)){
                        topic.subtopics = [topic.subtopics]
                    }
                    this.topic = topic

                    this.dispatch({
                        type: 'updatePath',
                        path: topic.topicsPath.map(el => {
                            return {
                                _id: el._id,
                                title: el.title,
                                link: "/admin/" + this.section +"/" + el._id
                            }
                        })
                    })
                })
            }

            getProblems(p, topic){
                if(!topic) return
                if(!p) p = 1
                this.problemsPage = p
                ajax().get("/api/problems/topic/" + this.topic._id + "/" + p)
                .then( res => {
                    this.problems = res
                })
            }

            topicChanged(topic){
                
                if(topic){
                    
                    this.path = topic.topicsPath

                    if(topic.path.split('/').length > 1){
                        this.problem = {
                            title: "Задачи в: " + topic.title,
                            buttonTitle: 'Добавить задачу'
                        } 
                    } else {
                        this.problem = null
                    }

                }
            }

        }
        customElements.define(DashboardModule.is, DashboardModule);
    </script>
</dom-module